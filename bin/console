#!/usr/bin/env php
<?php

namespace RetailCrm\Dev;

use ReflectionClass;
use RetailCrm\Dev\Component\PhpFilesIterator;
use Symfony\Component\Console\Application;

if (!in_array(PHP_SAPI, ['cli', 'phpdbg', 'embed'], true)) {
    echo 'Warning: The console should be invoked via the CLI version of PHP, not the '.PHP_SAPI.' SAPI'.PHP_EOL;
}

set_time_limit(0);

require dirname(__DIR__) . '/vendor/autoload.php';

if (!class_exists('Symfony\Component\Console\Application')) {
    echo 'Cannot find Symfony\Component\Console\Application class. Did you install devDependencies?';

    exit(-1);
}

$application = new Application();
$commands    = new PhpFilesIterator(implode(DIRECTORY_SEPARATOR, [dirname(__DIR__), 'dev', 'Command']));

foreach ($commands as $command) {
    if (!array_key_exists('fqn', $command)) {
        continue;
    }

    $commandFqn = $command['fqn'];

    if (class_exists($commandFqn) && !(new ReflectionClass($commandFqn))->isAbstract()) {
        $application->add(new $commandFqn());
    }
}

$application->setName('RetailCRM API Client Management Tool');
$application->run();
